#!/bin/bash
# verify - Lightweight verification script for tests and code quality
# Blocks Claude from stopping if tests fail or code quality issues exist
#
# Usage: verify (called as hook or CLI)

set -euo pipefail

# === HOOK DETECTION ===
IS_HOOK=false
STOP_HOOK_ACTIVE=false

if ! [[ -t 0 ]]; then
    INPUT=$(cat 2>/dev/null || true)
    if [[ -n "$INPUT" ]]; then
        IS_HOOK=true
        STOP_HOOK_ACTIVE=$(echo "$INPUT" | jq -r '.stop_hook_active // false' 2>/dev/null || echo "false")
    fi
fi

# Prevent infinite loops
if [[ "$STOP_HOOK_ACTIVE" == "true" ]]; then
    [[ "$IS_HOOK" == "true" ]] && echo '{"decision": "approve"}'
    exit 0
fi

# === OUTPUT HELPERS ===
output() { echo "$@" >&2; }

output_result() {
    local reason="$1"
    if [[ "$IS_HOOK" == "true" ]]; then
        if [[ -n "$reason" ]]; then
            echo "{\"decision\": \"block\", \"reason\": \"$reason\"}"
        else
            echo '{"decision": "approve"}'
        fi
    else
        if [[ -n "$reason" ]]; then
            output "❌ $reason"
            return 1
        else
            output "✅ All checks passed."
            return 0
        fi
    fi
}

# === CHECK: Code project? ===
is_code_project() {
    [[ -f "Makefile" || -f "package.json" || -f "go.mod" || -f "deno.json" || \
       -f "pom.xml" || -f "build.gradle" || -f "./gradlew" ]]
}

if ! is_code_project; then
    output_result ""
    exit 0
fi

# === FIND BASE BRANCH & SHOW DIFF ===
find_base_branch() {
    local main_date="" master_date=""
    git rev-parse --verify main >/dev/null 2>&1 && \
        main_date=$(git log -1 --format=%at main 2>/dev/null || echo "0")
    git rev-parse --verify master >/dev/null 2>&1 && \
        master_date=$(git log -1 --format=%at master 2>/dev/null || echo "0")
    [[ "${main_date:-0}" -gt "${master_date:-0}" ]] && echo "main" || echo "master"
}

BASE_BRANCH=$(find_base_branch)
git rev-parse --verify "$BASE_BRANCH" >/dev/null 2>&1 || BASE_BRANCH="HEAD~1"

# Parse diff stats
parse_diff_stats() {
    local summary="$1"
    local added=$(echo "$summary" | grep -oE '[0-9]+ insertions?\(' | grep -oE '^[0-9]+' || echo "0")
    local removed=$(echo "$summary" | grep -oE '[0-9]+ deletions?\(' | grep -oE '^[0-9]+' || echo "0")
    echo "$added $removed"
}

BRANCH_STATS=$(git diff --stat "$BASE_BRANCH..HEAD" 2>/dev/null | tail -1 || echo "")
BRANCH_PARSED=$(parse_diff_stats "$BRANCH_STATS")
BRANCH_ADDED=$(echo "$BRANCH_PARSED" | cut -d' ' -f1)
BRANCH_REMOVED=$(echo "$BRANCH_PARSED" | cut -d' ' -f2)

[[ "$BRANCH_ADDED" != "0" ]] && output "vs $BASE_BRANCH: +$BRANCH_ADDED, -$BRANCH_REMOVED"

# === CHECK: Net line count ===
NET_LINES=$((BRANCH_ADDED - BRANCH_REMOVED))
if [[ $NET_LINES -gt 300 ]]; then
    output_result "Too many lines added (net: $NET_LINES > 300)"
    exit 0
fi

# === GET CHANGED FILES (staged, unstaged, untracked) ===
CHANGED_FILES=$(
    (git diff --cached --name-only 2>/dev/null || true
     git diff --name-only 2>/dev/null || true
     git ls-files --others --exclude-standard 2>/dev/null || true) | sort -u
)

# === RUN TESTS ===
TEST_FAILED=0

if [[ -f "package.json" ]]; then
    output "Running npm test..."
    if ! npm test >&2; then
        TEST_FAILED=1
    fi
elif [[ -f "go.mod" ]] || [[ -f "Makefile" ]]; then
    output "Running make test..."
    if ! make test >&2; then
        TEST_FAILED=1
    fi
elif [[ -f "deno.json" ]]; then
    output "Running deno test..."
    if ! deno test >&2; then
        TEST_FAILED=1
    fi
elif [[ -f "./gradlew" ]]; then
    output "Running gradle test..."
    if ! ./gradlew test >&2; then
        TEST_FAILED=1
    fi
elif [[ -f "pom.xml" ]] && command -v mvn &>/dev/null; then
    output "Running mvn test..."
    if ! mvn test >&2; then
        TEST_FAILED=1
    fi
fi

[[ $TEST_FAILED -eq 1 ]] && {
    output_result "Tests failed"
    exit 0
}

# === RUN CODESCENE ===
if command -v cs &>/dev/null; then
    output "Running CodeScene review..."
    CS_FAILED=0

    while IFS= read -r file; do
        [[ -z "$file" ]] && continue
        LOCAL_FILE="$file"
        [[ ! -f "$LOCAL_FILE" ]] && LOCAL_FILE="${file#*/}"
        [[ ! -f "$LOCAL_FILE" ]] && continue

        OUTPUT=$(cs review "$LOCAL_FILE" 2>/dev/null)
        SCORE=$(echo "$OUTPUT" | grep -oE 'Overall code health score: ([0-9.]+)' | grep -oE '[0-9.]+' || echo "")

        if [[ -n "$SCORE" ]]; then
            if [[ "$SCORE" != "10.0" ]]; then
                output "❌ $(basename "$file"): $SCORE/10"
                echo "$OUTPUT" >&2
                CS_FAILED=1
            fi
        fi
    done <<< "$CHANGED_FILES"

    [[ $CS_FAILED -eq 1 ]] && {
        output_result "CodeScene: scores below 10/10"
        exit 0
    }
fi

# === SUCCESS ===
output_result ""
exit 0
