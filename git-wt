#!/bin/bash
#
# git-wt: Create a worktree with untracked files copied over
#
# Usage: git wt <name> [branch]
#
# Examples:
#   git wt fix           # creates ../reponame-fix on current branch
#   git wt hotfix main   # creates ../reponame-hotfix on main branch
#

set -e

EXCLUDE_PATTERNS=(
    'node_modules'
    '__pycache__'
    '.cache'
    '.venv'
    'venv'
    'dist'
    'build'
    'target'
    '.next'
    '.nuxt'
    '*.log'
    '*.tmp'
    '*.swp'
    '.DS_Store'
)

usage() {
    echo "Usage: git wt <name> [branch]"
    echo ""
    echo "Creates a worktree at ../reponame-<name> and copies untracked files."
    echo "If branch is omitted, uses the current branch."
    echo ""
    echo "Examples:"
    echo "  git wt fix           # ../myrepo-fix on current branch"
    echo "  git wt hotfix main   # ../myrepo-hotfix on main"
    exit 1
}

if [[ $# -lt 1 ]]; then
    usage
fi

NAME="$1"
BRANCH="${2:-$(git branch --show-current)}"

if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: not in a git repository"
    exit 1
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
REPO_NAME="$(basename "$REPO_ROOT")"
PARENT_DIR="$(dirname "$REPO_ROOT")"
WORKTREE_PATH="$PARENT_DIR/$REPO_NAME-$NAME"

if [[ -d "$WORKTREE_PATH" ]]; then
    echo "Error: $WORKTREE_PATH already exists"
    exit 1
fi

echo "Creating worktree: $WORKTREE_PATH"
echo "Branch: $BRANCH"
echo ""

git worktree add "$WORKTREE_PATH" "$BRANCH"

echo ""
echo "Copying untracked files..."

copied=0
while IFS= read -r file; do
    [[ -z "$file" ]] && continue

    skip=false
    for pattern in "${EXCLUDE_PATTERNS[@]}"; do
        if [[ "$file" == *"$pattern"* ]]; then
            skip=true
            break
        fi
    done
    [[ "$skip" == true ]] && continue

    mkdir -p "$WORKTREE_PATH/$(dirname "$file")"
    cp "$REPO_ROOT/$file" "$WORKTREE_PATH/$file"
    echo "  copied: $file"
    ((copied++)) || true

done < <(git ls-files --others --exclude-standard)

echo ""
echo "Done. Worktree ready at: $WORKTREE_PATH"
echo "Copied $copied untracked file(s)."
echo ""
echo "To remove: git worktree remove $WORKTREE_PATH"
